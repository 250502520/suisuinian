<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>站长碎碎念</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .text-content {
            white-space: pre-wrap;
            line-height: 1.6;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="max-w-3xl mx-auto p-4">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">碎碎念</h1>
            <p class="text-gray-500 mt-2">按文件名时间排序（最新在前，精确到分钟）</p>
        </header>

        <div id="fileContainer" class="space-y-8">
            <div id="loading" class="text-center py-10">
                <p class="text-gray-600">加载文件中...</p>
            </div>
        </div>
    </div>

    <script>
        const config = {
            username: "250502520",
            repo: "suisuinian",
            branch: "main" 
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadFilesByFileNameDateTime();
        });

        // 按文件名中的“年月日时分”加载并排序
        async function loadFilesByFileNameDateTime() {
            try {
                const fileListUrl = `https://api.github.com/repos/${config.username}/${config.repo}/contents?ref=${config.branch}`;
                const response = await fetch(fileListUrl);
                
                if (!response.ok) throw new Error(`API请求失败 (${response.status})`);
                
                const allFiles = await response.json();
                let txtFiles = allFiles.filter(file => 
                    file.type === 'file' && file.name.toLowerCase().endsWith('.txt')
                );
                
                if (txtFiles.length === 0) {
                    document.getElementById("fileContainer").innerHTML = 
                        '<p class="text-gray-600 text-center py-10">未找到任何txt文件</p>';
                    return;
                }

                // 提取文件名中的“年月日时分”
                txtFiles = txtFiles.map(file => {
                    const { date, dateTimeText } = extractDateTimeFromFileName(file.name);
                    return {
                        ...file,
                        fileNameDateTime: date, // 包含时分的日期对象（用于排序）
                        fileNameDateTimeText: dateTimeText // 格式化的“年月日 时分”文本（用于显示）
                    };
                });

                // 按“年月日时分”排序（最新的在前）
                txtFiles.sort((a, b) => {
                    const timeA = a.fileNameDateTime ? a.fileNameDateTime.getTime() : 0;
                    const timeB = b.fileNameDateTime ? b.fileNameDateTime.getTime() : 0;
                    return timeB - timeA;
                });

                displayFiles(txtFiles);
                
            } catch (error) {
                document.getElementById("fileContainer").innerHTML = 
                    `<p class="text-red-500 text-center py-10">加载失败：${error.message}</p>`;
            }
        }

        // 从文件名提取“年月日时分”（核心修改部分）
        function extractDateTimeFromFileName(fileName) {
            // 支持的包含时分的文件名格式正则
            const dateTimePatterns = [
                // 格式1：2023-10-05-14-30 或 2023-10-05-14:30
                { 
                    regex: /(\d{4})-(\d{2})-(\d{2})[-\:](\d{2})[-\:](\d{2})/, 
                    format: (y, m, d, h, min) => `${y}-${m}-${d} ${h}:${min}` 
                },
                // 格式2：202310051430（年月日时分连续数字）
                { 
                    regex: /(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/, 
                    format: (y, m, d, h, min) => `${y}-${m}-${d} ${h}:${min}` 
                },
                // 格式3：2023年10月05日14时30分 或 2023年10月05日14:30
                { 
                    regex: /(\d{4})年(\d{2})月(\d{2})日(\d{2})[时\:](\d{2})[分]?/, 
                    format: (y, m, d, h, min) => `${y}年${m}月${d}日 ${h}:${min}` 
                }
            ];

            for (const pattern of dateTimePatterns) {
                const match = fileName.match(pattern.regex);
                if (match) {
                    const [, year, month, day, hour, minute] = match;
                    // 验证日期和时间有效性（避免25:61这种无效时间）
                    const date = new Date(`${year}-${month}-${day}T${hour}:${minute}`);
                    if (date.getFullYear() == year && 
                        date.getMonth() + 1 == month && 
                        date.getDate() == day &&
                        date.getHours() == hour && 
                        date.getMinutes() == minute) {
                        return {
                            date: date,
                            dateTimeText: pattern.format(year, month, day, hour, minute)
                        };
                    }
                }
            }

            // 若未匹配到时分，尝试仅提取日期（兼容旧格式）
            const dateOnlyPatterns = [
                { regex: /(\d{4})-(\d{2})-(\d{2})/, format: (y, m, d) => `${y}-${m}-${d} 00:00` },
                { regex: /(\d{4})(\d{2})(\d{2})/, format: (y, m, d) => `${y}-${m}-${d} 00:00` },
                { regex: /(\d{4})年(\d{2})月(\d{2})日/, format: (y, m, d) => `${y}年${m}月${d}日 00:00` }
            ];
            for (const pattern of dateOnlyPatterns) {
                const match = fileName.match(pattern.regex);
                if (match) {
                    const [, year, month, day] = match;
                    const date = new Date(`${year}-${month}-${day}`);
                    if (date.getFullYear() == year && date.getMonth() + 1 == month && date.getDate() == day) {
                        return {
                            date: date,
                            dateTimeText: pattern.format(year, month, day)
                        };
                    }
                }
            }

            // 完全无有效时间
            return {
                date: null,
                dateTimeText: "文件名无有效时间"
            };
        }

        // 显示文件列表（使用文件名中的时分）
        async function displayFiles(files) {
            const container = document.getElementById("fileContainer");
            container.innerHTML = '';
            
            for (const file of files) {
                try {
                    const contentResponse = await fetch(file.url);
                    const contentData = await contentResponse.json();
                    let content = '';
                    try {
                        content = decodeURIComponent(escape(atob(contentData.content)));
                    } catch (e) {
                        content = `文件内容解码失败: ${e.message}`;
                    }
                    
                    const fileCard = document.createElement('div');
                    fileCard.className = "bg-white rounded-lg shadow-sm p-5 hover:shadow-md transition-shadow";
                    if (!file.fileNameDateTime) {
                        fileCard.classList.add("border-l-4", "border-yellow-400");
                    }
                    
                    fileCard.innerHTML = `
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-xl font-semibold text-gray-800">${file.name}</h3>
                            <span class="text-sm ${file.fileNameDateTime ? 'text-gray-500' : 'text-yellow-600'}">
                                ${file.fileNameDateTimeText}
                            </span>
                        </div>
                        <div class="text-content text-gray-700 bg-gray-50 p-4 rounded-md text-sm">
                            ${content}
                        </div>
                    `;
                    
                    container.appendChild(fileCard);
                } catch (error) {
                    const errorCard = document.createElement('div');
                    errorCard.className = "bg-red-50 rounded-lg p-5";
                    errorCard.innerHTML = `<p class="text-red-600">加载文件 ${file.name} 失败: ${error.message}</p>`;
                    container.appendChild(errorCard);
                }
            }
        }
    </script>
</body>
</html>
